name: Integration

on:
  push:
  pull_request:

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install docker compose plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin

      - name: Start full Docker Compose stack
        run: |
          docker compose up -d --build

      - name: Wait for services to become healthy
        run: |
          # wait up to ~2 minutes for vuln-api to respond
          for i in {1..30}; do
            if curl -fsS http://localhost:4000/reflect?input=ok >/dev/null 2>&1; then
              echo "vuln-api is up"
              break
            fi
            echo "waiting for vuln-api... ($i)"
            sleep 2
          done

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install vuln-api dependencies
        run: |
          cd infra/vuln-api
          npm install --no-audit --no-fund

      - name: Run vuln-api smoke tests
        run: npm --prefix infra/vuln-api test

      - name: Run lab health checks
        run: |
          chmod +x ./scripts/check_lab.sh || true
          ./scripts/check_lab.sh

      - name: Collect docker-compose logs
        run: docker compose logs --no-color > compose-logs.txt || true

      - name: Upload compose logs
        uses: actions/upload-artifact@v4
        with:
          name: compose-logs
          path: compose-logs.txt

      - name: Tear down stack
        if: always()
        run: docker compose down -v
